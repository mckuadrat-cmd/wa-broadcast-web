<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>MCKuadrat WA Center ‚Äì Kirim Pesan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mcgreen: "#25D366",
            mcdark: "#128C7E",
            mcorange: "#f97316"
          },
          fontFamily: {
            sans: ["system-ui", "ui-sans-serif", "sans-serif"]
          }
        }
      }
    }
  </script>

  <style>
    body {
      @apply font-sans;
      background: radial-gradient(circle at top, #f9731611, #ffffff 40%);
    }
  </style>
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">

  <!-- ========== GUARD LOGIN ========== -->
  <script>
    (function () {
      const logged = localStorage.getItem("sb_logged_in");
      const school = localStorage.getItem("sb_school");

      if (logged !== "1" || !school) {
        window.location.href = "/kirimpesan/";
      }
    })();
  </script>

  <!-- ========== WRAPPER APP ========== -->
  <div class="min-h-screen flex">

    <!-- ========== SIDEBAR ========== -->
    <aside class="w-64 bg-white border-r border-slate-200 flex flex-col">
      <div class="h-16 px-4 flex items-center gap-3 border-b border-slate-200">
        <div class="h-9 w-9 rounded-xl bg-gradient-to-br from-mcgreen to-mcdark flex items-center justify-center text-white text-xl">
          üí¨
        </div>
        <div>
          <div class="text-sm font-semibold">MCKuadrat WA Center</div>
          <div class="text-[11px] text-slate-500">Sekolah & Lembaga</div>
        </div>
      </div>

      <nav class="flex-1 px-2 py-3 space-y-1 text-sm">
        <a href="/kirimpesan/template.html"
           class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-600">
          <span>üìÑ</span>
          <span>Manage Template</span>
        </a>
        <a href="/kirimpesan/dashboard.html"
           class="flex items-center gap-2 px-3 py-2 rounded-lg bg-emerald-50 text-emerald-700 font-semibold">
          <span>üì§</span>
          <span>Kirim Pesan</span>
        </a>
        <a href="/kirimpesan/history.html"
           class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-600">
          <span>üïí</span>
          <span>Riwayat Broadcast</span>
        </a>
        <a href="/kirimpesan/inbox.html"
           class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-600">
          <span>üí¨</span>
          <span>Kotak Masuk</span>
        </a>
        <a href="/kirimpesan/billing.html"
           class="flex items-center gap-2 px-3 py-2 rounded-lg hover:bg-slate-100 text-slate-600">
          <span>üí≥</span>
          <span>Pembayaran</span>
        </a>
      </nav>

      <div class="px-3 py-3 border-t border-slate-200 text-[11px] text-slate-500">
        <div>MCKuadrat WhatsApp API</div>
        <div class="flex items-center gap-1">
          <span class="inline-flex h-2 w-2 rounded-full bg-emerald-500"></span>
          <span>Backend: ONLINE</span>
        </div>
      </div>
    </aside>

    <!-- ========== MAIN AREA ========== -->
    <div class="flex-1 flex flex-col">

      <!-- TOPBAR -->
      <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-6">
        <div>
          <div class="text-sm font-semibold">Kirim Pesan</div>
          <div class="text-xs text-slate-500">
            Kirim broadcast, atur jadwal, dan follow-up dari satu tempat.
          </div>
        </div>
        <div class="flex items-center gap-3 text-xs text-slate-600">
          <span id="schoolLabel" class="font-medium">Sekolah Pesat Bogor</span>
          <button
            onclick="logout()"
            class="px-3 py-1 rounded-full border border-slate-200 hover:bg-slate-50 text-[11px] text-slate-600">
            Logout
          </button>
        </div>
      </header>

      <!-- CONTENT -->
      <main class="flex-1 p-6 bg-slate-50">
        <!-- NANTI ISI FORM KIRIM PESAN DI SINI -->
        <div
          id="broadcastContent"
          class="max-w-6xl mx-auto grid gap-4 md:grid-cols-2"
        >
          <!-- Kiri: card template + pengaturan, kanan: recipients + summary dst -->
        </div>
      </main>
    </div>
  </div>

  <!-- ========== TOAST GLOBAL (bisa pakai yg lama) ========== -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div
      id="toastInner"
      class="flex items-start gap-2 rounded-lg bg-slate-900/90 px-4 py-3 text-sm text-white shadow-lg"
    >
      <div id="toastIcon" class="mt-0.5 text-lg">‚è≥</div>
      <div>
        <p id="toastTitle" class="text-sm font-semibold">Processing‚Ä¶</p>
        <p id="toastMessage" class="mt-0.5 text-xs opacity-80">
          Please wait, do not close this page.
        </p>
      </div>
    </div>
  </div>

  <!-- ========== SCRIPT GLOBAL (logout + label sekolah) ========== -->
  <script>
    (function () {
      const storedSchool = localStorage.getItem("sb_school") || "sekolahpesatbogor";
      const SCHOOL_MAP = {
        "sekolahpesatbogor": "Sekolah Pesat Bogor"
      };
      const label = SCHOOL_MAP[storedSchool] || storedSchool;
      const el = document.getElementById("schoolLabel");
      if (el) el.textContent = label;
    })();

    function logout() {
      localStorage.removeItem("sb_logged_in");
      localStorage.removeItem("sb_school");
      window.location.href = "/kirimpesan/";
    }

    function showToast(title, message, icon = "‚è≥", duration = 3000) {
      const toast = document.getElementById("toast");
      const titleEl = document.getElementById("toastTitle");
      const msgEl = document.getElementById("toastMessage");
      const iconEl = document.getElementById("toastIcon");

      if (!toast || !titleEl || !msgEl || !iconEl) return;

      titleEl.textContent = title;
      msgEl.textContent = message;
      iconEl.textContent = icon;

      toast.classList.remove("hidden");

      clearTimeout(showToast._timeoutId);
      showToast._timeoutId = setTimeout(() => {
        toast.classList.add("hidden");
      }, duration);
    }
  </script>
  
    // =======================
    // KONSTAN BACKEND
    // =======================
// Domain backend (tanpa path)
const API_BASE   = "https://api.mckuadrat.com";
const API_PREFIX = "/kirimpesan";

// Semua endpoint dibangun dari 1 prefix
const BACKEND_BROADCAST_URL       = `${API_BASE}${API_PREFIX}/broadcast`;
const BACKEND_TEMPLATES_URL       = `${API_BASE}${API_PREFIX}/templates`;
const BACKEND_CREATE_TEMPLATE_URL = `${API_BASE}${API_PREFIX}/templates/create`;
const BACKEND_SENDERS_URL         = `${API_BASE}${API_PREFIX}/senders`;
const BACKEND_LOG_DETAIL_URL      = `${API_BASE}${API_PREFIX}/broadcast/logs/`;

const DEFAULT_FOLLOWUP_FILENAME = "Surat_Penerimaan_{{1}}.pdf";

    let templates  = [];
    let recipients = []; // { phone, var1, var2, ... }
    let currentSenderPhone = "";
    let currentMaxVar = 0; // jumlah var {{n}} di template aktif

    // =======================
    // LABEL SEKOLAH + URL
    // =======================
    (function () {
      const storedSchool = localStorage.getItem("sb_school") || "sekolahpesatbogor";

      const SCHOOL_MAP = {
        "sekolahpesatbogor": "Sekolah Pesat Bogor"
      };

      const label = SCHOOL_MAP[storedSchool] || storedSchool;
      const el = document.getElementById("schoolLabel");
      if (el) el.textContent = label;

      // sinkron query ?school=...
      const params = new URLSearchParams(window.location.search);
      if (params.get("school") !== storedSchool) {
        params.set("school", storedSchool);
        const newUrl = window.location.pathname + "?" + params.toString();
        window.history.replaceState({}, "", newUrl);
      }
    })();

    function logout() {
      localStorage.removeItem("sb_logged_in");
      localStorage.removeItem("sb_school");
      window.location.href = "/kirimpesan/";
    }

    // =======================
    // TOAST HELPER
    // =======================
    function showToast(title, message, icon = "‚è≥", duration = 3000) {
      const toast = document.getElementById("toast");
      const titleEl = document.getElementById("toastTitle");
      const msgEl = document.getElementById("toastMessage");
      const iconEl = document.getElementById("toastIcon");

      if (!toast || !titleEl || !msgEl || !iconEl) return;

      titleEl.textContent = title;
      msgEl.textContent = message;
      iconEl.textContent = icon;

      toast.classList.remove("hidden");

      clearTimeout(showToast._timeoutId);
      showToast._timeoutId = setTimeout(() => {
        toast.classList.add("hidden");
      }, duration);
    }

    // =======================
    // SENDER NUMBER (WABA)
    // =======================

    const FALLBACK_SENDERS = [
      {
        phone: "6285129120664",
        label: "6285129120664 - Sekolah Pesat Bogor"
      }
    ];

    currentSenderPhone =
      localStorage.getItem("sb_sender_phone") ||
      (FALLBACK_SENDERS[0] && FALLBACK_SENDERS[0].phone) ||
      "";

    async function initSenderSelect() {
      const sel = document.getElementById("senderSelect");
      if (!sel) return;

      sel.innerHTML = "<option>Loading...</option>";

      let senders = [];

      try {
        const res  = await fetch(BACKEND_SENDERS_URL);
        if (res.ok) {
          const data = await res.json();
          if (data && data.status === "ok" && Array.isArray(data.senders)) {
            senders = data.senders;
          }
        }
      } catch (e) {
        console.warn("Error load /senders, pakai fallback:", e);
      }

      if (!senders.length) {
        senders = FALLBACK_SENDERS;
      }

      sel.innerHTML = "";
      senders.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s.phone;
        opt.textContent = s.label || s.phone;
        sel.appendChild(opt);
      });

      if (currentSenderPhone) {
        sel.value = currentSenderPhone;
      }

      sel.addEventListener("change", () => {
        currentSenderPhone = sel.value;
        localStorage.setItem("sb_sender_phone", currentSenderPhone);
      });
    }

    // =======================
    // RECIPIENT UI
    // =======================

    function updateRecipientUI() {
      const count = recipients.length;
      document.getElementById("recipientCount").textContent    = count;
      document.getElementById("summaryRecipients").textContent = count;

      const listEl = document.getElementById("recipientList");
      listEl.innerHTML = "";

      if (!count) {
        listEl.classList.add("hidden");
        return;
      }
      listEl.classList.remove("hidden");

      recipients.forEach((r, idx) => {
        const row = document.createElement("div");
        row.className =
          "flex items-center justify-between rounded border border-slate-200 bg-white px-2 py-1";

        const varLabels = Object.keys(r)
          .filter((k) => /^var\d+$/.test(k) && r[k])
          .sort((a, b) => {
            const na = parseInt(a.replace("var", ""), 10);
            const nb = parseInt(b.replace("var", ""), 10);
            return na - nb;
          })
          .map((k) => {
            const idxVar = k.replace("var", "");
            return `{{${idxVar}}}: ${r[k]}`;
          });

        row.innerHTML = `
          <div>
            <div class="font-mono">${r.phone}</div>
            ${
              varLabels.length
                ? `<div class="text-[11px] text-slate-500">${varLabels.join(" ¬∑ ")}</div>`
                : ""
            }
          </div>
          <button data-idx="${idx}" class="text-xs text-red-500 hover:underline">Remove</button>
        `;
        listEl.appendChild(row);
      });

      listEl.querySelectorAll("button[data-idx]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-idx"), 10);
          if (!isNaN(i)) {
            recipients.splice(i, 1);
            updateRecipientUI();
          }
        });
      });
    }

    function updateSummarySchedule() {
      const val       = document.getElementById("schedule").value;
      const summaryEl = document.getElementById("summarySchedule");
      const labelEl   = document.getElementById("sendBtnLabel");

      if (!val) {
        summaryEl.textContent = "Immediately";
        labelEl.textContent   = "Send Broadcast Now";
        return;
      }
      const dt = new Date(val);
      if (isNaN(dt.getTime())) {
        summaryEl.textContent = "Immediately";
        labelEl.textContent   = "Send Broadcast Now";
        return;
      }
      summaryEl.textContent = dt.toLocaleString();
      labelEl.textContent   = "Schedule Broadcast";
    }

    // =======================
    // TEMPLATE
    // =======================

    function getTemplateBodyText(tpl) {
      if (!tpl || !Array.isArray(tpl.components)) return "";
      const body = tpl.components.find((c) => c.type === "BODY");
      return (body && body.text) || "";
    }

    function renderTemplateButtons(tpl) {
      const container = document.getElementById("templateButtonsPreview");
      if (!container) return;
      container.innerHTML = "";

      if (!tpl || !Array.isArray(tpl.components)) return;
      const btnComp = tpl.components.find((c) => c.type === "BUTTONS");
      if (!btnComp || !Array.isArray(btnComp.buttons)) return;

      btnComp.buttons.forEach((b) => {
        const span = document.createElement("span");
        span.className =
          "inline-flex items-center rounded-full border border-slate-300 bg-slate-50 px-2 py-1 text-[11px] text-slate-700";
        span.textContent = b.text || "(button)";
        container.appendChild(span);
      });
    }

    async function loadTemplates() {
      const sel      = document.getElementById("templateSelect");
      const statusEl = document.getElementById("templateStatus");
      statusEl.textContent = "Loading...";

      try {
        const res  = await fetch(BACKEND_TEMPLATES_URL + "?status=APPROVED");
        const data = await res.json();

        if (data.status !== "ok") {
          sel.innerHTML = '<option value="">Failed to load templates</option>';
          statusEl.textContent = "Error";
          console.error("Templates error:", data);
          showToast("Error", "Failed to load templates.", "‚ö†Ô∏è");
          return;
        }

        templates = Array.isArray(data.templates) ? data.templates : [];
        if (!templates.length) {
          sel.innerHTML = '<option value="">No approved templates</option>';
          statusEl.textContent = "Empty";
          showToast("Info", "No approved templates found.", "‚ÑπÔ∏è");
          return;
        }

        sel.innerHTML = '<option value="">Choose a template...</option>';
        templates.forEach((t) => {
          const opt = document.createElement("option");
          opt.value = t.name;
          opt.textContent = `${t.name} [${t.category}/${t.language}]`;
          sel.appendChild(opt);
        });
        statusEl.textContent = templates.length + " templates";
        showToast("Loaded", `Loaded ${templates.length} templates.`, "‚úÖ", 2000);
      } catch (err) {
        console.error(err);
        sel.innerHTML = '<option value="">Error loading templates</option>';
        statusEl.textContent = "Error";
        showToast("Error", "Error loading templates from backend.", "‚ö†Ô∏è");
      }
    }

    function countVars(text) {
      const matches = text.match(/\{\{(\d+)\}\}/g);
      if (!matches) return 0;
      const nums = matches.map(m => parseInt(m.replace(/[{}]/g, ""), 10));
      return Math.max(...nums);
    }
        
    // =======================
    // ADD VARIABLE BUTTON (Body Text builder)
    // =======================

    function getNextVarIndexFromText(text) {
      const re = /\{\{(\d+)\}\}/g;
      let max = 0;
      let m;
      while ((m = re.exec(text)) !== null) {
        const n = parseInt(m[1], 10);
        if (!isNaN(n) && n > max) max = n;
      }
      return max + 1;
    }

    function initAddVariableButton() {
      const btn = document.getElementById("btnAddVariable");
      const ta  = document.getElementById("tpl_body");
      if (!btn || !ta) return;

      btn.addEventListener("click", () => {
        const text      = ta.value || "";
        const nextIndex = getNextVarIndexFromText(text);
        const insertStr = `{{${nextIndex}}}`;

        const start = ta.selectionStart ?? text.length;
        const end   = ta.selectionEnd ?? text.length;

        ta.value = text.slice(0, start) + insertStr + text.slice(end);
        ta.focus();
        const caretPos = start + insertStr.length;
        ta.selectionStart = caretPos;
        ta.selectionEnd   = caretPos;

        updateExamplesFromBody();
      });
    }

    // =======================
    // TEMPLATE APPROVAL MONITOR
    // =======================

    async function isTemplateApproved(tplName) {
      try {
        const res  = await fetch(BACKEND_TEMPLATES_URL + "?status=APPROVED");
        const data = await res.json();
        if (data.status !== "ok") return false;
        const list = Array.isArray(data.templates) ? data.templates : [];
        return list.some((t) => t.name === tplName);
      } catch (err) {
        console.error("check template approved error:", err);
        return false;
      }
    }

    function startTemplateApprovalMonitor(tplName) {
      const modal = document.getElementById("tplMonitorModal");
      const textEl = document.getElementById("tplMonitorText");
      const infoEl = document.getElementById("tplMonitorInfo");
      const closeBtn = document.getElementById("tplMonitorClose");

      if (!modal || !textEl || !infoEl || !closeBtn) return;

      modal.classList.remove("hidden");
      modal.classList.add("flex");

      let elapsed = 0;
      const interval = 10;    // detik
      const maxTime  = 120;   // 2 menit
      let stopped = false;

      function stop() {
        if (stopped) return;
        stopped = true;
        clearInterval(startTemplateApprovalMonitor._timerId);
      }

      closeBtn.onclick = () => {
        stop();
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      };

      async function tick() {
        if (stopped) return;

        textEl.textContent = `Mengecek status template "${tplName}"...`;
        infoEl.textContent = `Sudah menunggu ${elapsed} detik. Mengecek lagi dalam ${interval} detik.`;

        const approved = await isTemplateApproved(tplName);
        if (approved) {
          textEl.textContent = `Template "${tplName}" sudah APPROVED ‚úÖ`;
          infoEl.textContent = "Dropdown template akan diperbarui otomatis.";
          showToast("Approved", `Template "${tplName}" sudah approved.`, "‚úÖ", 3500);

          await loadTemplates();

          setTimeout(() => {
            modal.classList.add("hidden");
            modal.classList.remove("flex");
          }, 3000);

          stop();
          return;
        }

        elapsed += interval;
        if (elapsed >= maxTime) {
          textEl.textContent = `Template "${tplName}" masih dalam proses review.`;
          infoEl.textContent = "Coba cek lagi nanti atau klik Submit lagi bila perlu.";
          showToast("Info", "Template masih dalam review. Cek lagi nanti.", "‚ÑπÔ∏è", 3500);
          stop();
        }
      }

      tick();
      startTemplateApprovalMonitor._timerId = setInterval(tick, interval * 1000);
    }

    // =======================
    // MANUAL VAR HELPERS
    // =======================

    function getMaxVarIndexFromText(text) {
      const re = /\{\{(\d+)\}\}/g;
      let max = 0;
      let m;
      while ((m = re.exec(text)) !== null) {
        const n = parseInt(m[1], 10);
        if (!isNaN(n) && n > max) max = n;
      }
      return max;
    }

    function renderManualVarInputs(maxVar) {
      const container = document.getElementById("manualVarsContainer");
      if (!container) return;

      container.innerHTML = "";

      if (!maxVar) {
        container.innerHTML =
          '<p class="text-[11px] text-slate-500">Pilih template dulu untuk melihat kolom variabel.</p>';
        return;
      }

      for (let i = 1; i <= maxVar; i++) {
        const wrapper = document.createElement("div");
        wrapper.className = "space-y-1";

        wrapper.innerHTML = `
          <label class="block text-[11px] text-slate-600">
            Nilai untuk <span class="font-mono">{{${i}}}</span>
          </label>
          <input
            id="manualVar${i}"
            type="text"
            placeholder="Contoh nilai untuk {{${i}}}"
            class="w-full rounded-md border border-slate-300 bg-slate-50 px-3 py-2 text-sm outline-none focus:ring-1 focus:ring-[#f7542e]"
          />
        `;
        container.appendChild(wrapper);
      }
    }

    // =======================
    // EXAMPLES FOLLOW BODY TEXT
    // =======================

    function updateExamplesFromBody() {
      const ta = document.getElementById("tpl_body");
      const container = document.getElementById("tpl_examples_container");
      if (!ta || !container) return;

      const text = ta.value || "";
      const matches = [...text.matchAll(/\{\{(\d+)\}\}/g)];

      container.innerHTML = "";

      if (!matches.length) {
        container.innerHTML =
          '<p class="text-[11px] text-slate-500">Tambahkan {{1}}, {{2}}, dst pada Body Text. Input contoh akan muncul otomatis di sini.</p>';
        return;
      }

      const indices = [...new Set(matches.map((m) => parseInt(m[1], 10)))]
        .filter((n) => !isNaN(n))
        .sort((a, b) => a - b);

      indices.forEach((i) => {
        const row = document.createElement("div");
        row.className = "flex items-center gap-2";
        row.innerHTML = `
          <span class="inline-flex h-5 items-center rounded bg-slate-100 px-2 font-mono text-[11px] text-slate-700">{{${i}}}</span>
          <input
            type="text"
            data-example-index="${i}"
            class="flex-1 rounded-md border border-slate-300 bg-slate-50 px-2 py-1 text-[11px] outline-none focus:ring-1 focus:ring-[#f7542e]"
            placeholder="Contoh nilai untuk {{${i}}}"
          />
        `;
        container.appendChild(row);
      });
    }

    // =======================
    // BROADCAST RESULT MODAL
    // =======================
    let broadcastModalRowMap = {};

    // Modal awal: status "Sending..." per nomor
    function openBroadcastPendingModal(rows) {
      const modal    = document.getElementById("broadcastModal");
      const closeBtn = document.getElementById("broadcastModalClose");
      const bodyEl   = document.getElementById("broadcastModalBody");
      const sumEl    = document.getElementById("broadcastSummaryText");
      if (!modal || !bodyEl || !sumEl || !closeBtn) return;

      bodyEl.innerHTML = "";
      broadcastModalRowMap = {};

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1 text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 font-mono text-slate-800">${r.phone}</td>
          <td class="px-2 py-1 text-slate-700">-</td>
          <td class="px-2 py-1 text-slate-600">Sending...</td>
          <td class="px-2 py-1 text-slate-600 followup-cell">-</td>
          <td class="px-2 py-1 text-slate-500">-</td>
        `;
        bodyEl.appendChild(tr);
        if (r.phone) {
          broadcastModalRowMap[String(r.phone)] = tr;
        }
      });

      sumEl.textContent = `Mengirim ke ${rows.length} penerima...`;

      modal.classList.remove("hidden");
      modal.classList.add("flex");

      closeBtn.onclick = () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      };
    }

    // Modal final: setelah backend respon
    function openBroadcastModal(broadcastData, hasFollowup) {
      const modal    = document.getElementById("broadcastModal");
      const closeBtn = document.getElementById("broadcastModalClose");
      const bodyEl   = document.getElementById("broadcastModalBody");
      const sumEl    = document.getElementById("broadcastSummaryText");
      if (!modal || !bodyEl || !sumEl || !closeBtn) return;

      bodyEl.innerHTML = "";
      broadcastModalRowMap = {};

      const results = Array.isArray(broadcastData.results) ? broadcastData.results : [];
      let okCount = 0;
      let failCount = 0;

      const followupLabelDefault = hasFollowup
        ? "Belum (menunggu reply)"
        : "-";

      results.forEach((r, idx) => {
        if (r.ok) okCount++; else failCount++;

        const tr   = document.createElement("tr");
        const rec  = recipients.find((x) => x.phone === r.phone) || {};
        const info1 = rec.var1 || "-";

        tr.innerHTML = `
          <td class="px-2 py-1 text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 font-mono text-slate-800">${r.phone || "-"}</td>
          <td class="px-2 py-1 text-slate-700">${info1}</td>
          <td class="px-2 py-1 ${r.ok ? "text-emerald-600" : "text-red-600"}">
            ${r.ok ? "OK" : "FAILED"}
          </td>
          <td class="px-2 py-1 text-slate-600 followup-cell">
            ${followupLabelDefault}
          </td>
          <td class="px-2 py-1 text-slate-500">
            ${
              r.error
                ? (typeof r.error === "string"
                    ? r.error
                    : JSON.stringify(r.error).slice(0, 80) + "...")
                : "-"
            }
          </td>
        `;

        bodyEl.appendChild(tr);

        if (r.phone) {
          broadcastModalRowMap[String(r.phone)] = tr;
        }
      });

      sumEl.textContent =
        `Total: ${results.length} penerima ¬∑ Sukses: ${okCount} ¬∑ Gagal: ${failCount}`;

      modal.classList.remove("hidden");
      modal.classList.add("flex");

      closeBtn.onclick = () => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
      };

      if (hasFollowup && broadcastData.broadcast_id) {
        startFollowupWatcher(broadcastData.broadcast_id);
      }
    }

    function startFollowupWatcher(broadcastId) {
      const intervalMs   = 5000;   // cek tiap 5 detik
      const maxAttempts  = 60;     // ¬±5 menit
      let attempts       = 0;

      const timerId = setInterval(async () => {
        attempts++;
        if (attempts > maxAttempts) {
          clearInterval(timerId);
          return;
        }

        try {
          const res  = await fetch(BACKEND_LOG_DETAIL_URL + encodeURIComponent(broadcastId));
          if (!res.ok) return;

          const data = await res.json();
          if (data.status !== "ok") return;

          const followups = (data.log && data.log.followups) || [];

          followups.forEach((f) => {
            const phone = String(f.phone || "");
            const tr    = broadcastModalRowMap[phone];
            if (!tr) return;

            const cell = tr.querySelector("td.followup-cell");
            if (!cell) return;

            if (f.status === "ok") {
              cell.textContent = "Terkirim";
              cell.classList.remove("text-slate-600", "text-red-600");
              cell.classList.add("text-emerald-600");
            } else if (f.status === "error") {
              cell.textContent = "Gagal";
              cell.classList.remove("text-slate-600", "text-emerald-600");
              cell.classList.add("text-red-600");
            }
          });
        } catch (err) {
          console.warn("followup watcher error:", err);
        }
      }, intervalMs);
    }

    // =======================
    // DOM READY
    // =======================
    document.addEventListener("DOMContentLoaded", () => {
      initSenderSelect();
      loadTemplates();
      initAddVariableButton();
      renderManualVarInputs(0);
      updateExamplesFromBody();
    
      // Body text ‚Üí update examples
      const bodyTa = document.getElementById("tpl_body");
      if (bodyTa) {
        ["input", "change", "blur"].forEach((evt) => {
          bodyTa.addEventListener(evt, updateExamplesFromBody);
        });
      }
    
      // ==========================
      // PILIH TEMPLATE ‚Üí PREVIEW
      // ==========================
      const selTpl    = document.getElementById("templateSelect");
      const previewEl = document.getElementById("messagePreview");
    
      if (selTpl && previewEl) {
        selTpl.addEventListener("change", () => {
          const name = selTpl.value;
          const tpl  = templates.find((t) => t.name === name);
          const bodyText = getTemplateBodyText(tpl) || "";
    
          previewEl.value = bodyText;
          document.getElementById("summaryTemplate").textContent =
            name || "Not selected";
    
          // hitung variabel {{n}} dari body
          currentMaxVar = countVars(bodyText);   // pakai fungsi yang kamu buat
          renderManualVarInputs(currentMaxVar);
          renderTemplateButtons(tpl);
        });
      }
 
      // Manual add recipient
      document
        .getElementById("btnAddRecipient")
        .addEventListener("click", () => {
          const input = document.getElementById("manualPhone");
          const phone = input.value.trim();
          if (!phone) return;

          if (recipients.some((r) => r.phone === phone)) {
            input.value = "";
            return;
          }

          const newRec = { phone };

          if (currentMaxVar > 0) {
            for (let i = 1; i <= currentMaxVar; i++) {
              const el = document.getElementById(`manualVar${i}`);
              const val = el ? el.value.trim() : "";
              if (val) {
                newRec[`var${i}`] = val;
              }
            }
          }

          recipients.push(newRec);
          input.value = "";
          updateRecipientUI();
        });

      document
        .getElementById("manualPhone")
        .addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("btnAddRecipient").click();
          }
        });

      // CSV upload button ‚Üí trigger input
      const csvInput = document.getElementById("csvFile");
      const csvBtn   = document.getElementById("btnUploadCsv");
      if (csvBtn && csvInput) {
        csvBtn.addEventListener("click", () => csvInput.click());
      }

      // CSV upload (phone,var1,var2,...,link)
      document
        .getElementById("csvFile")
        .addEventListener("change", async (e) => {
          const file   = e.target.files[0];
          const infoEl = document.getElementById("csvInfo");
          if (!file) {
            infoEl.textContent = "";
            return;
          }
          try {
            const text  = await file.text();
            const lines = text
              .split(/\r?\n/)
              .map((l) => l.trim())
              .filter((l) => l.length > 0);

            // Skip header jika baris pertama mengandung huruf
            if (lines.length > 0 && /[a-zA-Z]/.test(lines[0])) {
              lines.shift(); // buang header
            }

            let added = 0;

            for (const line of lines) {
              const colsRaw = line.split(",");
              if (!colsRaw.length) continue;

              const phone = (colsRaw[0] || "").trim();
              if (!phone) continue;
              if (recipients.some((r) => r.phone === phone)) continue;

              const cols = colsRaw.slice(1).map((c) => c.trim());

              const row = { phone };

              if (cols.length > 0) {
                const lastIdx = cols.length - 1;

                cols.forEach((val, idx) => {
                  if (!val) return;
                  if (idx < lastIdx) {
                    const key = "var" + (idx + 1);
                    row[key] = val;
                  } else {
                    row.follow_media = val;
                  }
                });
              }

              recipients.push(row);
              added++;
            }

            infoEl.textContent = `${added} new recipients from CSV`;
            updateRecipientUI();
          } catch (err) {
            console.error(err);
            infoEl.textContent = "Failed to read CSV";
          }
        });

      // Schedule
      document
        .getElementById("schedule")
        .addEventListener("change", updateSummarySchedule);

      // SEND BROADCAST
      document
        .getElementById("sendBtn")
        .addEventListener("click", async () => {
          const outputEl     = document.getElementById("output");
          const sel          = document.getElementById("templateSelect");
          const templateName = sel.value;
      
          if (!templateName) {
            alert("Please select a template.");
            return;
          }
          if (!recipients.length) {
            alert("Add at least one recipient.");
            return;
          }
      
          const bodyPayload = {
            template_name: templateName,
            rows: recipients
          };
      
          if (currentSenderPhone) {
            bodyPayload.sender_phone = currentSenderPhone;
          }
      
          // === jadwal kirim (optional) ===
          const scheduleVal = document.getElementById("schedule").value;
          if (scheduleVal) {
            bodyPayload.scheduled_at = scheduleVal;
          }
      
          // FOLLOWUP CONFIG
          const followText       = document.getElementById("followupText")?.value.trim() || "";
          const followAttach     = document.getElementById("followupAttachment")?.value.trim() || "";
          let   followAttachName = document.getElementById("followupAttachmentName")?.value.trim() || "";
          
          if (followText) {
            const followup = { text: followText };
            if (followAttach) {
          
              // kalau kosong, pakai default
              if (!followAttachName) {
                followAttachName = DEFAULT_FOLLOWUP_FILENAME;
              }
          
              const staticMedia = {
                type: "document",
                link: followAttach,
                filename: followAttachName
              };
          
              followup.static_media = staticMedia;
            }
            bodyPayload.followup = followup;
          }
      
          // === BUKA MODAL DULU DENGAN STATUS "MENGIRIM..." ===
          const pendingRows = recipients.map((r) => ({
            phone: r.phone
          }));
          openBroadcastPendingModal(pendingRows);
      
          outputEl.textContent = `Sending to ${recipients.length} recipients...`;
      
          try {
            const res = await fetch(BACKEND_BROADCAST_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(bodyPayload)
            });
      
            const data = await res.json();
            outputEl.textContent = JSON.stringify(data, null, 2);
      
            // treat "ok" dan "scheduled" sama-sama sebagai sukses
            if (res.ok && (data.status === "ok" || data.status === "scheduled")) {
              const hasFollowup = !!followText; // apakah follow-up dipakai
              openBroadcastModal(data, hasFollowup);
      
              const toastLabel =
                data.status === "scheduled"
                  ? "Broadcast berhasil dijadwalkan."
                  : "Broadcast selesai dikirim.";
      
              showToast("Success", toastLabel, "‚úÖ", 3500);
            } else {
              showToast("Error", "Broadcast error. Cek detail di bawah.", "‚ö†Ô∏è", 4000);
            }
          } catch (err) {
            console.error("Error saat send broadcast:", err);
            outputEl.textContent = "Error: " + err.message;
            showToast("Error", "Broadcast error: " + err.message, "‚ö†Ô∏è", 4000);
          }
        });

      // CREATE TEMPLATE
      document
        .getElementById("btnCreateTpl")
        .addEventListener("click", async () => {
          const name      = document.getElementById("tpl_name").value.trim();
          const category  = document.getElementById("tpl_category").value;
          const body_text = document.getElementById("tpl_body").value.trim();
          const footer    = document.getElementById("tpl_footer").value.trim();
          const btn1      = document.getElementById("tpl_btn1").value.trim();
          const btn2      = document.getElementById("tpl_btn2").value.trim();
          const btn3      = document.getElementById("tpl_btn3").value.trim();
          const outEl     = document.getElementById("tplResult");
          const statusEl  = document.getElementById("tplStatus");

          if (!name || !category || !body_text) {
            alert("Template name, category, dan body wajib diisi.");
            return;
          }

          const exampleInput = document.querySelector("#tpl_examples_container input[data-example-index]");
          const example_1 = exampleInput ? exampleInput.value.trim() : "";

          const buttons = [btn1, btn2, btn3].filter((b) => b.length > 0);
          outEl.textContent = "Submitting template to Meta...";
          statusEl.textContent = "Mengajukan template ke Meta...";
          showToast("Submitting", "Submitting template to Meta...", "‚è≥", 4000);

          try {
            const res  = await fetch(BACKEND_CREATE_TEMPLATE_URL, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name,
                category,
                body_text,
                example_1,
                footer_text: footer,
                buttons
              })
            });
            const data = await res.json();
            outEl.textContent = JSON.stringify(data, null, 2);

            if (res.ok && (data.status === "ok" || data.status === "submitted")) {
              statusEl.textContent = "Template submitted. Waiting for Meta review.";
              showToast("Success", "Template submitted for review.", "‚úÖ", 3000);
              startTemplateApprovalMonitor(name);
            } else {
              statusEl.textContent = "Template submission error. See details below.";
              showToast("Error", "Template submission error.", "‚ö†Ô∏è", 4000);
            }
          } catch (err) {
            console.error(err);
            outEl.textContent = "Error: " + err.message;
            statusEl.textContent = "Error submitting template.";
            showToast("Error", "Error submitting template: " + err.message, "‚ö†Ô∏è", 4000);
          }
        });
    });
  </script>

</body>
</html>
