<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Riwayat Broadcast - MCKuadrat WA API</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mcgreen: "#25D366",
            mcdark: "#128C7E"
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: linear-gradient(to bottom, #ffe9df, #ffffff 40%, #ffffff 60%, #ffe9df);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 text-slate-900">

  <!-- Guard login -->
  <script>
    (function () {
      const logged = localStorage.getItem("sb_logged_in");
      const school = localStorage.getItem("sb_school");
      if (logged !== "1" || !school) {
        window.location.href = "/kirimpesan/";
      }
    })();
  </script>

  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">
    <!-- Top bar -->
    <header class="w-full border-b border-slate-200 bg-white">
      <div class="mx-auto flex items-center justify-between px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-[#f7542e]/10">
            <span class="text-2xl">üìä</span>
          </div>
          <div>
            <div class="text-sm font-semibold">Riwayat Broadcast</div>
            <div class="text-xs text-slate-500">Log pengiriman pesan WhatsApp</div>
          </div>
        </div>

        <div class="hidden text-xs sm:flex sm:items-center sm:gap-4 text-slate-500">
          <span>
            Hai, <span id="schoolLabel" class="font-medium">Sekolah Pesat Bogor</span>
          </span>

          <a href="/kirimpesan/dashboard.html"
             class="font-semibold text-mcgreen underline hover:text-mcdark">
            Kembali ke Dashboard
          </a>

          <button onclick="logout()" class="font-semibold text-red-500 underline">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main content -->
    <main class="px-6 py-6 bg-white">
      <div class="mb-4 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div class="space-y-1">
          <h1 class="text-sm font-semibold text-slate-800">Daftar Riwayat Broadcast</h1>
          <p class="text-xs text-slate-500">
            Menampilkan daftar broadcast terakhir yang tersimpan di database.
          </p>
        </div>

        <div class="flex items-center gap-2">
          <label class="text-xs text-slate-500">
            Limit:
            <select id="limitSelect"
                    class="ml-1 rounded-md border border-slate-300 bg-slate-50 px-2 py-1 text-xs outline-none">
              <option value="20">20</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </label>

          <button
            id="btnRefresh"
            type="button"
            class="rounded-md border border-slate-300 bg-slate-50 px-3 py-1.5 text-xs font-medium hover:bg-slate-100"
          >
            üîÑ Refresh
          </button>
        </div>
      </div>

      <!-- Status -->
      <div
        id="logStatus"
        class="mb-3 rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-[11px] text-slate-600"
      >
        Memuat data log...
      </div>

      <!-- Table -->
      <div class="overflow-auto border border-slate-200 rounded-xl max-h-[60vh]">
        <table class="min-w-full text-[11px]">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="px-3 py-2 text-left font-semibold text-slate-600">#</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-600">Waktu</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-600">Template</th>
              <th class="px-3 py-2 text-left font-semibold text-slate-600">Sender</th>
              <th class="px-3 py-2 text-center font-semibold text-slate-600">Total</th>
              <th class="px-3 py-2 text-center font-semibold text-orange-600">Pending</th>
              <th class="px-3 py-2 text-center font-semibold text-emerald-600">OK</th>
              <th class="px-3 py-2 text-center font-semibold text-red-600">Gagal</th>
              <th class="px-3 py-2 text-center font-semibold text-slate-600">Follow-up</th>
              <th class="px-3 py-2 text-center font-semibold text-slate-600">Aksi</th>
            </tr>
          </thead>
          <tbody id="logTableBody" class="divide-y divide-slate-100">
            <!-- rows via JS -->
          </tbody>
        </table>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div
      class="flex items-start gap-2 rounded-lg bg-slate-900/90 px-4 py-3 text-sm text-white shadow-lg"
    >
      <div id="toastIcon" class="mt-0.5 text-lg">‚è≥</div>
      <div>
        <p id="toastTitle" class="text-sm font-semibold">Status</p>
        <p id="toastMessage" class="mt-0.5 text-xs opacity-80">
          ...
        </p>
      </div>
    </div>
  </div>

<script>
  const API_BASE = "https://api.mckuadrat.com/kirimpesan/";

  function logout() {
    localStorage.removeItem("sb_logged_in");
    localStorage.removeItem("sb_school");
    window.location.href = "/kirimpesan/";
  }

  // label sekolah
  (function () {
    const storedSchool = localStorage.getItem("sb_school") || "sekolahpesatbogor";
    const SCHOOL_MAP = { "sekolahpesatbogor": "Sekolah Pesat Bogor" };
    const label = SCHOOL_MAP[storedSchool] || storedSchool;
    const el = document.getElementById("schoolLabel");
    if (el) el.textContent = label;
  })();

  function showToast(title, message, icon = "‚è≥", duration = 2500) {
    const toast = document.getElementById("toast");
    const tEl   = document.getElementById("toastTitle");
    const mEl   = document.getElementById("toastMessage");
    const iEl   = document.getElementById("toastIcon");
    if (!toast || !tEl || !mEl || !iEl) return;
    tEl.textContent = title;
    mEl.textContent = message;
    iEl.textContent = icon;
    toast.classList.remove("hidden");

    clearTimeout(showToast._id);
    showToast._id = setTimeout(() => {
      toast.classList.add("hidden");
    }, duration);
  }

  function formatDateTime(iso) {
    if (!iso) return "-";
    const d = new Date(iso);
    if (isNaN(d.getTime())) return iso;
    return d.toLocaleString();
  }

  async function loadLogs() {
    const statusEl = document.getElementById("logStatus");
    const tbody    = document.getElementById("logTableBody");
    const limit    = parseInt(document.getElementById("limitSelect").value || "50", 10);

    statusEl.textContent = "Mengambil data dari server...";
    tbody.innerHTML = "";

    try {
      const res  = await fetch(API_BASE + "broadcast/logs?limit=" + limit);
      const data = await res.json();

      if (!res.ok || data.status !== "ok") {
        statusEl.textContent = "Gagal memuat data log. Coba refresh.";
        showToast("Error", "Gagal memuat data log.", "‚ö†Ô∏è", 3000);
        console.error("Logs error:", data);
        return;
      }

      const logs = Array.isArray(data.logs) ? data.logs : [];
      if (!logs.length) {
        statusEl.textContent = "Belum ada data broadcast di database.";
        tbody.innerHTML = "";
        return;
      }

      statusEl.textContent = `Menampilkan ${logs.length} broadcast terakhir.`;

      logs.forEach((log, idx) => {
        const tr = document.createElement("tr");
      
        const created = formatDateTime(log.created_at);
        const sender  = log.sender_phone || "-";
        const tpl     = log.template_name || "-";
      
        const total  = Number(log.total || 0);
        const ok = Number(log.total || 0) - Number(log.followup_count || 0);
        const fail   = Number(log.failed || 0);
        const pending = Math.max(0, total - ok - fail);
      
        const follow  = Number(log.followup_count || 0);
      
        tr.innerHTML = `
          <td class="px-3 py-1.5 text-slate-500">${idx + 1}</td>
          <td class="px-3 py-1.5 text-slate-700 whitespace-nowrap">${created}</td>
          <td class="px-3 py-1.5 text-slate-700">${tpl}</td>
          <td class="px-3 py-1.5 text-slate-600">${sender}</td>
          <td class="px-3 py-1.5 text-center">${total}</td>
          <td class="px-3 py-1.5 text-center text-orange-600">${pending}</td>
          <td class="px-3 py-1.5 text-center text-emerald-600">${ok}</td>
          <td class="px-3 py-1.5 text-center text-red-600">${fail}</td>
          <td class="px-3 py-1.5 text-center">${follow}</td>
          <td class="px-3 py-1.5 text-center">
            <a href="/kirimpesan/broadcast-log-detail.html?id=${encodeURIComponent(log.id)}"
               class="inline-flex items-center rounded-full border border-slate-300 px-3 py-1 text-[11px] text-slate-700 hover:bg-slate-100">
              Detail
            </a>
          </td>
        `;
      
        tbody.appendChild(tr);
      });

      showToast("Loaded", "Riwayat broadcast berhasil dimuat.", "‚úÖ", 2000);
    } catch (err) {
      console.error(err);
      statusEl.textContent = "Error koneksi ke server.";
      showToast("Error", "Tidak bisa terhubung ke server.", "‚ö†Ô∏è", 3000);
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("btnRefresh").addEventListener("click", loadLogs);
    document.getElementById("limitSelect").addEventListener("change", loadLogs);
    loadLogs();
  });
</script>

</body>
</html>
