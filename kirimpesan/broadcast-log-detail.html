<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Detail Broadcast ‚Äì MCKuadrat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mcgreen: "#25D366",
            mcdark: "#128C7E"
          }
        }
      }
    };
  </script>
  <style>
    body {
      background: linear-gradient(to bottom, #ffe9df, #ffffff 40%, #ffffff 60%, #ffe9df);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 text-slate-900">

  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden my-8">
    <!-- HEADER -->
    <header class="border-b border-slate-200 bg-white px-6 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-[#f7542e]/10">
          <span class="text-2xl">üìä</span>
        </div>
        <div>
          <div class="text-sm font-semibold">Detail Broadcast</div>
          <div class="text-xs text-slate-500">
            Rincian pengiriman &amp; follow-up untuk 1 broadcast
          </div>
        </div>
      </div>
      <div class="text-right text-xs">
        <div class="text-slate-500">Hai, <span id="schoolLabel" class="font-semibold">Sekolah Pesat Bogor</span></div>
        <div class="flex items-center justify-end gap-3 mt-1">
          <a href="/kirimpesan/broadcast-log.html"
             class="text-mcgreen font-semibold underline">
            ‚Üê Kembali ke Riwayat
          </a>
          <button
            onclick="logout()"
            class="text-red-500 font-semibold underline">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- BODY -->
    <main class="px-6 py-5 space-y-4">
      <!-- Info broadcast -->
      <section class="rounded-xl border border-slate-200 bg-slate-50 px-4 py-3 text-xs md:text-sm">
        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
          <div>
            <p class="font-semibold text-slate-800 mb-1">Informasi Broadcast</p>
            <p><span class="text-slate-500">ID:</span> <span id="bcId" class="font-mono">-</span></p>
            <p><span class="text-slate-500">Waktu:</span> <span id="bcTime">-</span></p>
            <p><span class="text-slate-500">Template:</span> <span id="bcTemplate">-</span></p>
          </div>
          <div>
            <p class="font-semibold text-slate-800 mb-1">Sender &amp; Follow-up</p>
            <p><span class="text-slate-500">Sender:</span> <span id="bcSenderPhone">-</span></p>
            <p><span class="text-slate-500">Phone ID:</span> <span id="bcPhoneId" class="font-mono">-</span></p>
            <p><span class="text-slate-500">Follow-up:</span> <span id="bcFollowupStatus">-</span></p>
          </div>
          <div>
            <p class="font-semibold text-slate-800 mb-1">Ringkasan Penerima</p>
            <p>Total: <span id="sumTotal" class="font-semibold">0</span></p>
            <p>OK: <span id="sumOk" class="text-emerald-600 font-semibold">0</span></p>
            <p>Gagal: <span id="sumFail" class="text-red-500 font-semibold">0</span></p>
            <p>Follow-up terkirim: <span id="sumFollowOk" class="text-emerald-600 font-semibold">0</span></p>
          </div>
        </div>
      </section>

      <!-- Tabel gabungan -->
      <section class="rounded-xl border border-slate-200 bg-white p-4 text-[11px] md:text-xs">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2">
          <h2 class="font-semibold text-slate-800">
            Data Penerima, Status Template &amp; Follow-up
          </h2>
          <div class="flex items-center gap-2">
            <button
              id="btnDownloadCsv"
              class="rounded-md border border-slate-300 bg-slate-50 px-3 py-1 text-[11px] md:text-xs font-medium text-slate-700 hover:bg-slate-100 active:bg-slate-200">
              Download CSV Laporan
            </button>
            <p id="bcStatusText" class="text-[11px] text-slate-500">
              Detail berhasil dimuat.
            </p>
          </div>
        </div>

        <div class="overflow-auto border border-slate-200 rounded-lg">
          <table class="min-w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">#</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Nomor</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Var (Template)</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Follow Media (Template)</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">HTTP</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">OK?</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Error Template</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Waktu Follow-up</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Has Media</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Media Link</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Status Follow-up</th>
                <th class="px-2 py-1 text-left font-semibold text-slate-600">Error Follow-up</th>
              </tr>
            </thead>
            <tbody id="combinedBody" class="divide-y divide-slate-100">
              <!-- rows via JS -->
            </tbody>
          </table>
        </div>

        <p class="mt-2 text-[11px] text-slate-500">
          *Setiap baris mewakili 1 nomor. Kolom kiri adalah status pengiriman template,
          kolom kanan adalah status pesan follow-up (quick reply).
        </p>
      </section>
    </main>
  </div>

  <!-- Toast simple -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="rounded-lg bg-slate-900/90 px-3 py-2 text-xs text-white shadow-lg">
      <span id="toastText">Loading...</span>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.mckuadrat.com/kirimpesan/";
    const BACKEND_LOG_DETAIL_URL = API_BASE + "broadcast/logs/";

    // state global buat CSV
    let currentBroadcast = {};
    let currentRecipients = [];
    let currentFollowups = [];

    function showToast(msg, duration = 2500) {
      const el = document.getElementById("toast");
      const txt = document.getElementById("toastText");
      if (!el || !txt) return;
      txt.textContent = msg;
      el.classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => {
        el.classList.add("hidden");
      }, duration);
    }

    function logout() {
      localStorage.removeItem("sb_logged_in");
      localStorage.removeItem("sb_school");
      window.location.href = "/kirimpesan/";
    }

    (function setSchoolLabel() {
      const storedSchool = localStorage.getItem("sb_school") || "sekolahpesatbogor";
      const SCHOOL_MAP = { "sekolahpesatbogor": "Sekolah Pesat Bogor" };
      const label = SCHOOL_MAP[storedSchool] || storedSchool;
      const el = document.getElementById("schoolLabel");
      if (el) el.textContent = label;
    })();

    function formatDateTime(str) {
      if (!str) return "-";
      const d = new Date(str);
      if (isNaN(d.getTime())) return str;
      return d.toLocaleString("id-ID");
    }

    function safe(obj, def = "-") {
      if (obj === null || typeof obj === "undefined" || obj === "") return def;
      return obj;
    }

    function formatVars(vars) {
      if (!vars) return "-";
      if (typeof vars === "string") return vars;
      if (Array.isArray(vars)) return vars.join(" | ");
      if (typeof vars === "object") {
        return Object.keys(vars)
          .sort()
          .map(k => `${k}: ${vars[k]}`)
          .join(" | ") || "-";
      }
      return String(vars);
    }

    async function loadBroadcastDetail() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      if (!id) {
        showToast("ID broadcast tidak ditemukan di URL");
        return;
      }

      showToast("Memuat detail broadcast...");

      try {
        const res = await fetch(BACKEND_LOG_DETAIL_URL + encodeURIComponent(id));
        const data = await res.json();

        if (!res.ok || data.status !== "ok") {
          console.error("detail error:", data);
          document.getElementById("bcStatusText").textContent = "Gagal memuat detail.";
          showToast("Gagal memuat detail.");
          return;
        }

        // struktur: { log: { broadcast, recipients, followups } }
        const log        = data.log || {};
        const broadcast  = log.broadcast  || {};
        const recipients = log.recipients || [];
        const followups  = log.followups  || [];

        // simpan ke state global buat CSV
        currentBroadcast = broadcast;
        currentRecipients = recipients;
        currentFollowups = followups;

        fillHeader(broadcast, recipients, followups);
        renderCombinedTable(recipients, followups);

        document.getElementById("bcStatusText").textContent = "Detail berhasil dimuat.";
        showToast("Detail berhasil dimuat.");
      } catch (err) {
        console.error(err);
        document.getElementById("bcStatusText").textContent = "Error memuat detail.";
        showToast("Error memuat detail.");
      }
    }

    function fillHeader(broadcast, recipients, followups) {
      document.getElementById("bcId").textContent       = broadcast.id || "-";
      document.getElementById("bcTime").textContent     = formatDateTime(broadcast.created_at);
      document.getElementById("bcTemplate").textContent = broadcast.template_name || "-";
      document.getElementById("bcSenderPhone").textContent =
        broadcast.sender_phone || "-";
      document.getElementById("bcPhoneId").textContent =
        broadcast.phone_number_id || "-";
      document.getElementById("bcFollowupStatus").textContent =
        broadcast.followup_enabled ? "Aktif" : "Nonaktif";
    }

    function renderCombinedTable(recipients, followups) {
      const body = document.getElementById("combinedBody");
      body.innerHTML = "";

      // map follow-up by phone
      const folMap = {};
      followups.forEach(f => {
        if (!f.phone) return;
        folMap[String(f.phone)] = f;
      });

      let total = 0;
      let okCount = 0;
      let failCount = 0;
      let followOk = 0;

      recipients.forEach((r, idx) => {
        total++;

      const http = r.template_http_status;
      const err  = r.template_error;
      const vars = r.vars_json;
      const f    = folMap[String(r.phone || "")] || {};
      
      // tentukan status template
      let statusLabel = "PENDING";
      let statusClass = "text-slate-500";
      
      if (r.template_ok === true) {
        statusLabel = "OK";
        statusClass = "text-emerald-600";
        okCount++;
      } else if (r.template_ok === false || typeof http === "number") {
        // sudah ada respon tapi gagal
        statusLabel = "FAILED";
        statusClass = "text-red-600";
        failCount++;
      }
      
      // follow-up
      if (f.status === "ok") {
        followOk++;
      }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="px-2 py-1 text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 font-mono text-slate-800">${safe(r.phone)}</td>
          <td class="px-2 py-1 text-slate-700">${formatVars(vars)}</td>
          <td class="px-2 py-1 text-slate-600 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis">
            ${safe(r.follow_media)}
          </td>
          <td class="px-2 py-1 text-slate-600">${safe(http)}</td>
          <td class="px-2 py-1 ${statusClass}">
            ${statusLabel}
          </td>
          <td class="px-2 py-1 text-slate-500 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis">
            ${
              err
                ? (typeof err === "string"
                    ? err
                    : JSON.stringify(err).slice(0, 80) + "...")
                : "-"
            }
          </td>
          <td class="px-2 py-1 text-slate-600">${f.at ? formatDateTime(f.at) : "-"}</td>
          <td class="px-2 py-1 text-slate-600">${typeof f.has_media === "boolean" ? (f.has_media ? "Ya" : "Tidak") : "-"}</td>
          <td class="px-2 py-1 text-slate-600 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis">
            ${safe(f.media_link)}
          </td>
          <td class="px-2 py-1 ${
            f.status === "ok" ? "text-emerald-600" :
            f.status === "error" ? "text-red-600" :
            "text-slate-500"
          }">
            ${safe(f.status)}
          </td>
          <td class="px-2 py-1 text-slate-500 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis">
            ${
              f.error
                ? (typeof f.error === "string"
                    ? f.error
                    : JSON.stringify(f.error).slice(0, 80) + "...")
                : "-"
            }
          </td>
        `;
        body.appendChild(tr);
      });

      document.getElementById("sumTotal").textContent    = total;
      document.getElementById("sumOk").textContent       = okCount;
      document.getElementById("sumFail").textContent     = failCount;
      document.getElementById("sumFollowOk").textContent = followOk;
    }

    // ===== Helper buat CSV =====
    function csvEscape(value) {
      if (value === null || typeof value === "undefined") return "";
      let str = String(value);
      // handle line break
      if (/[",\n\r]/.test(str)) {
        str = '"' + str.replace(/"/g, '""') + '"';
      }
      return str;
    }

    function downloadCsvReport() {
      if (!currentRecipients.length) {
        showToast("Tidak ada data penerima untuk diunduh.");
        return;
      }

      // map follow-up by phone (lagi, biar aman)
      const folMap = {};
      currentFollowups.forEach(f => {
        if (!f.phone) return;
        folMap[String(f.phone)] = f;
      });

      const header = [
        "broadcast_id",
        "phone",
        "vars",
        "follow_media",
        "template_ok",
        "template_http_status",
        "template_error",
        "follow_status",
        "follow_at",
        "follow_has_media",
        "follow_media_link",
        "follow_error"
      ];

      const rows = [header.join(",")];

      currentRecipients.forEach(r => {
        const f = folMap[String(r.phone || "")] || {};

        const line = [
          csvEscape(currentBroadcast.id || ""),
          csvEscape(r.phone || ""),
          csvEscape(formatVars(r.vars_json)),
          csvEscape(r.follow_media || ""),
          csvEscape(r.template_ok === true ? "OK" : (r.template_ok === false ? "FAILED" : "")),
          csvEscape(r.template_http_status || ""),
          csvEscape(
            r.template_error
              ? (typeof r.template_error === "string"
                  ? r.template_error
                  : JSON.stringify(r.template_error))
              : ""
          ),
          csvEscape(f.status || ""),
          csvEscape(f.at ? formatDateTime(f.at) : ""),
          csvEscape(
            typeof f.has_media === "boolean"
              ? (f.has_media ? "Ya" : "Tidak")
              : ""
          ),
          csvEscape(f.media_link || ""),
          csvEscape(
            f.error
              ? (typeof f.error === "string"
                  ? f.error
                  : JSON.stringify(f.error))
              : ""
          )
        ];

        rows.push(line.join(","));
      });

      const csvContent = rows.join("\r\n");
      const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      const ts = new Date().toISOString().replace(/[:.]/g, "-");
      a.href = url;
      a.download = `broadcast-${currentBroadcast.id || "log"}-${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadBroadcastDetail();

      const btnCsv = document.getElementById("btnDownloadCsv");
      if (btnCsv) {
        btnCsv.addEventListener("click", downloadCsvReport);
      }
    });
  </script>
</body>
</html>
