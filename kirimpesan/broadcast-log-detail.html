<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>MCKuadrat · Detail Broadcast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mcgreen: "#25D366",
            mcdark: "#128C7E"
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: linear-gradient(to bottom, #ffe9df, #ffffff 40%, #ffffff 60%, #ffe9df);
    }
  </style>
</head>

<body class="min-h-screen text-slate-900">

<!-- ============================= -->
<!-- LOGIN GUARD -->
<!-- ============================= -->
<script>
  (function () {
    const logged = localStorage.getItem("sb_logged_in");
    if (logged !== "1") {
      window.location.href = "/kirimpesan/";
    }
  })();
</script>

<!-- PAGE WRAPPER -->
<div class="max-w-6xl mx-auto mt-10 bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">

  <!-- HEADER -->
  <header class="border-b border-slate-200 bg-white">
    <div class="px-6 py-4 flex items-center justify-between">
      <div>
        <h1 class="text-lg font-semibold">Detail Broadcast</h1>
        <p id="headerSubtitle" class="text-xs text-slate-500">
          Memuat detail...
        </p>
      </div>
      <div class="flex items-center gap-3">
        <a href="/kirimpesan/broadcast-log.html"
           class="text-xs font-semibold text-mcgreen hover:text-mcdark underline">
          ← Kembali ke Riwayat
        </a>
      </div>
    </div>
  </header>

  <!-- CONTENT -->
  <main class="px-6 py-6 space-y-5">

    <!-- SUMMARY CARD -->
    <section id="summaryCard" class="rounded-xl border border-slate-200 bg-slate-50 p-4 text-sm">
      <p class="text-xs text-slate-500 mb-1">Broadcast ID:</p>
      <p id="summaryId" class="font-mono text-xs mb-2 text-slate-700">-</p>

      <div class="grid gap-2 sm:grid-cols-3 text-xs sm:text-sm">
        <p>Template: <span id="summaryTemplate" class="font-mono text-slate-800">-</span></p>
        <p>Dibuat: <span id="summaryCreated" class="text-slate-800">-</span></p>
        <p>Sender: <span id="summarySender" class="text-slate-800">-</span></p>
      </div>

      <div class="mt-3 grid gap-2 sm:grid-cols-4 text-xs sm:text-sm">
        <p>Total penerima: <span id="summaryTotal" class="font-semibold text-slate-800">0</span></p>
        <p>Sukses template: <span id="summaryOk" class="font-semibold text-emerald-600">0</span></p>
        <p>Gagal template: <span id="summaryFail" class="font-semibold text-red-500">0</span></p>
        <p>Follow-up terkirim: <span id="summaryFollow" class="font-semibold text-mcgreen">0</span></p>
      </div>

      <div class="mt-3 flex flex-wrap items-center gap-3">
        <button
          id="downloadCsvBtn"
          class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 hover:bg-slate-100"
        >
          ⬇ Download CSV
        </button>
        <span id="followupLabel" class="text-[11px] px-2 py-1 rounded-full bg-slate-200 text-slate-700">
          Follow-up: -
        </span>
      </div>
    </section>

    <!-- TABLE -->
    <section class="rounded-xl border border-slate-200 bg-white p-4 text-xs sm:text-sm">
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-sm font-semibold">Daftar Penerima</h2>
        <p id="tableInfo" class="text-[11px] text-slate-500">
          Menampilkan semua penerima.
        </p>
      </div>

      <div class="border border-slate-200 rounded-lg overflow-auto max-h-[60vh]">
        <table class="min-w-full text-[11px] sm:text-xs">
          <thead class="bg-slate-50 border-b border-slate-200">
            <tr>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">#</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">Nomor</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">Info 1 / Nama</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">Template</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">HTTP</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">Follow-up</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">Media</th>
              <th class="px-2 py-1 text-left font-semibold text-slate-600">Follow-up At</th>
            </tr>
          </thead>
          <tbody id="detailTableBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="8" class="px-2 py-3 text-center text-slate-500">
                Loading...
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <p class="mt-2 text-[11px] text-slate-500">
        *Kolom "Info 1 / Nama" diisi dari <span class="font-mono">var1</span> pada CSV atau input manual.
      </p>
    </section>
  </main>
</div>

<script>
  const API_BASE = "https://api.mckuadrat.com/kirimpesan/";

  function getQueryId() {
    const params = new URLSearchParams(window.location.search);
    return params.get("id") || "";
  }

  function escapeHtml(str) {
    return String(str || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;");
  }

  async function loadDetail() {
    const id = getQueryId();
    const headerSubtitle = document.getElementById("headerSubtitle");
    const tbody = document.getElementById("detailTableBody");
    const summaryId = document.getElementById("summaryId");
    const summaryTemplate = document.getElementById("summaryTemplate");
    const summaryCreated = document.getElementById("summaryCreated");
    const summarySender = document.getElementById("summarySender");
    const summaryTotal = document.getElementById("summaryTotal");
    const summaryOk = document.getElementById("summaryOk");
    const summaryFail = document.getElementById("summaryFail");
    const summaryFollow = document.getElementById("summaryFollow");
    const followupLabel = document.getElementById("followupLabel");
    const tableInfo = document.getElementById("tableInfo");
    const downloadBtn = document.getElementById("downloadCsvBtn");

    if (!id) {
      headerSubtitle.textContent = "ID broadcast tidak ditemukan di URL.";
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-2 py-3 text-center text-red-500">
            ID broadcast tidak ditemukan.
          </td>
        </tr>
      `;
      return;
    }

    headerSubtitle.textContent = "Memuat detail broadcast...";
    summaryId.textContent = id;

    // Set URL download CSV
    downloadBtn.onclick = () => {
      window.open(API_BASE + "broadcast/logs/" + encodeURIComponent(id) + "/csv", "_blank");
    };

    try {
      const res = await fetch(API_BASE + "broadcast/logs/" + encodeURIComponent(id));
      const data = await res.json();

      if (!res.ok || data.status !== "ok") {
        headerSubtitle.textContent = "Gagal memuat detail broadcast.";
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-2 py-3 text-center text-red-500">
              Gagal memuat data. ${escapeHtml(data.error || "")}
            </td>
          </tr>
        `;
        return;
      }

      const log = data.log || {};
      const rows = Array.isArray(log.rows) ? log.rows : [];
      const results = Array.isArray(log.results) ? log.results : [];
      const followups = Array.isArray(log.followups) ? log.followups : [];

      // Summary
      const createdAt = log.created_at ? new Date(log.created_at).toLocaleString() : "-";
      const total = results.length;
      const okCount = results.filter((r) => r.ok).length;
      const failCount = total - okCount;
      const followCount = followups.length;

      summaryTemplate.textContent = log.template_name || "-";
      summaryCreated.textContent = createdAt;
      summarySender.textContent = log.sender_phone || "-";
      summaryTotal.textContent = total;
      summaryOk.textContent = okCount;
      summaryFail.textContent = failCount;
      summaryFollow.textContent = followCount;

      followupLabel.textContent = log.followup_enabled
        ? "Follow-up: AKTIF"
        : "Follow-up: NON-AKTIF";

      followupLabel.className =
        "text-[11px] px-2 py-1 rounded-full " +
        (log.followup_enabled
          ? "bg-emerald-50 text-emerald-700 border border-emerald-200"
          : "bg-slate-100 text-slate-600 border border-slate-200");

      headerSubtitle.textContent = "Detail broadcast berhasil dimuat.";
      tableInfo.textContent = `Total ${total} penerima. ${okCount} sukses, ${failCount} gagal. Follow-up terkirim ke ${followCount} nomor.`;

      // Index map untuk hasil & follow-up per nomor
      const resultMap = {};
      results.forEach((r) => {
        if (r.phone) {
          resultMap[String(r.phone)] = r;
        }
      });

      const followMap = {};
      followups.forEach((f) => {
        if (f.phone) {
          followMap[String(f.phone)] = f; // jika ada lebih dari satu, yg terakhir overwrite
        }
      });

      // Bangun tabel
      tbody.innerHTML = "";

      if (!rows.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="px-2 py-3 text-center text-slate-500">
              Tidak ada data penerima di log ini.
            </td>
          </tr>
        `;
        return;
      }

      rows.forEach((row, idx) => {
        const phone = row.phone || row.to || "";
        if (!phone) return;

        const result = resultMap[String(phone)] || {};
        const follow = followMap[String(phone)] || {};

        const info1 = row.var1 || "-";
        const templateOk = result.ok ? "OK" : "FAILED";
        const templateClass = result.ok ? "text-emerald-600" : "text-red-600";
        const httpStatus = result.status != null ? String(result.status) : "-";

        const followStatus = follow.status || "-";
        const followClass =
          followStatus === "ok"
            ? "text-emerald-600"
            : followStatus === "error"
            ? "text-red-600"
            : "text-slate-500";

        const hasMedia = follow.has_media ? "Ya" : (row.follow_media ? "Ya (row)" : "Tidak");
        const followAt = follow.at ? new Date(follow.at).toLocaleString() : "-";

        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td class="px-2 py-1 text-slate-500">${idx + 1}</td>
          <td class="px-2 py-1 font-mono text-slate-800">${escapeHtml(phone)}</td>
          <td class="px-2 py-1 text-slate-700">${escapeHtml(info1)}</td>
          <td class="px-2 py-1 ${templateClass}">${templateOk}</td>
          <td class="px-2 py-1 text-slate-500">${escapeHtml(httpStatus)}</td>
          <td class="px-2 py-1 ${followClass}">${escapeHtml(followStatus)}</td>
          <td class="px-2 py-1 text-slate-700">${escapeHtml(hasMedia)}</td>
          <td class="px-2 py-1 text-slate-500">${escapeHtml(followAt)}</td>
        `;

        tbody.appendChild(tr);
      });
    } catch (err) {
      headerSubtitle.textContent = "Error memuat detail broadcast.";
      tbody.innerHTML = `
        <tr>
          <td colspan="8" class="px-2 py-3 text-center text-red-500">
            Error: ${escapeHtml(err.message)}
          </td>
        </tr>
      `;
    }
  }

  document.addEventListener("DOMContentLoaded", loadDetail);
</script>

</body>
</html>
