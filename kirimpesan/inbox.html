<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>MCKuadrat ‚Äì Kotak Masuk WA</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mcgreen: "#25D366",
            mcdark: "#128C7E"
          }
        }
      }
    }
  </script>
  <style>
    body {
      background: linear-gradient(to bottom, #ffe9df, #ffffff 40%, #ffffff 60%, #ffe9df);
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center px-4 text-slate-900">

  <!-- Guard: wajib login -->
  <script>
    (function () {
      const logged = localStorage.getItem("sb_logged_in");
      const school = localStorage.getItem("sb_school");
      if (logged !== "1" || !school) {
        window.location.href = "/kirimpesan/";
      }
    })();
  </script>

  <div class="w-full max-w-6xl bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden">

    <!-- Top Bar -->
    <header class="w-full border-b border-slate-200 bg-white">
      <div class="mx-auto flex items-center justify-between px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-[#f7542e]/10">
            <span class="text-2xl">üì•</span>
          </div>
          <div>
            <div class="text-sm font-semibold">Kotak Masuk WhatsApp</div>
            <div class="text-xs text-slate-500">
              Percakapan per nomor dengan tampilan mirip WhatsApp.
            </div>
          </div>
        </div>

        <div class="hidden text-sm text-slate-500 sm:flex sm:items-center sm:gap-4">
          Hai, <span id="schoolLabel" class="font-medium">Sekolah Pesat Bogor</span>

          <a
            href="/kirimpesan/dashboard.html"
            class="text-xs font-semibold text-mcgreen underline hover:text-mcdark"
          >
            ‚Üê Kembali ke Dashboard
          </a>

          <button onclick="logout()" class="text-xs font-semibold text-red-500 underline">
            Logout
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="mx-auto px-6 py-6 bg-white">
      <div class="mb-4 flex items-center justify-between">
        <div>
          <h2 class="text-sm font-semibold text-slate-800">Inbox Percakapan</h2>
          <p class="text-xs text-slate-500">
            Menampilkan percakapan per nomor. Data pesan diambil dari webhook (inbound).
          </p>
        </div>
        <div class="flex items-center gap-2">
          <span id="inboxCount" class="text-xs text-slate-500">0 percakapan</span>
          <button
            id="btnRefresh"
            type="button"
            class="rounded-md border border-slate-300 bg-slate-50 px-3 py-1 text-xs font-medium hover:bg-slate-100"
          >
            Refresh
          </button>
        </div>
      </div>

      <!-- 2 kolom: kiri list thread, kanan chat window -->
      <div class="grid gap-4 md:grid-cols-[minmax(0,1.1fr)_minmax(0,1.9fr)]">

        <!-- LEFT: daftar thread per nomor -->
        <section class="rounded-xl border border-slate-200 bg-white flex flex-col max-h-[70vh]">
          <div class="border-b border-slate-100 px-3 py-2 flex items-center justify-between">
            <div class="text-xs font-semibold text-slate-700">Daftar Percakapan</div>
            <span class="text-[11px] text-slate-500" id="threadSummary">-</span>
          </div>

          <div id="threadList" class="flex-1 overflow-y-auto">
            <!-- diisi oleh JS -->
          </div>

          <p class="px-3 py-2 text-[11px] text-slate-500 border-t border-slate-100">
            *Nama diambil dari <span class="font-mono">var1</span> pada broadcast (jika tersedia).
          </p>
        </section>

        <!-- RIGHT: chat bubble ala WhatsApp -->
        <section class="rounded-xl border border-slate-200 bg-white flex flex-col max-h-[70vh]">

          <!-- Header chat -->
          <div class="border-b border-slate-100 px-3 py-2 flex items-center justify-between">
            <div>
              <div id="chatTitle" class="text-xs font-semibold text-slate-800">
                Pilih percakapan di sebelah kiri
              </div>
              <div id="chatSubtitle" class="text-[11px] text-slate-500">
                Nomor & nama akan tampil di sini.
              </div>
            </div>
            <div id="chatMeta" class="text-[11px] text-slate-500 text-right">
              -
            </div>
          </div>

          <!-- Chat messages -->
          <div id="chatWindow" class="flex-1 overflow-y-auto px-3 py-3 bg-slate-50">
            <!-- bubble chat dari JS -->
          </div>

          <!-- Composer -->
          <div class="border-t border-slate-200 px-3 py-2 bg-white">
            <div class="flex items-end gap-2">
              <textarea
                id="replyText"
                rows="2"
                class="flex-1 rounded-2xl border border-slate-300 bg-slate-50 px-3 py-2 text-xs outline-none focus:ring-1 focus:ring-mcgreen"
                placeholder="Tulis balasan ke nomor ini..."
              ></textarea>
              <button
                id="btnSendReply"
                type="button"
                class="inline-flex items-center justify-center rounded-full bg-mcgreen text-white px-4 py-2 text-xs font-semibold hover:bg-mcdark disabled:opacity-40 disabled:cursor-not-allowed"
                disabled
              >
                Kirim
              </button>
            </div>
            <p class="mt-1 text-[10px] text-slate-500">
              Balasan dikirim sebagai pesan WhatsApp biasa (customer-initiated conversation).
            </p>
          </div>
        </section>

      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-4 right-4 z-50 hidden">
    <div class="flex items-start gap-2 rounded-lg bg-slate-900/90 px-4 py-3 text-sm text-white shadow-lg">
      <div class="mt-0.5 text-lg">‚ÑπÔ∏è</div>
      <p id="toastText" class="mt-0.5 text-xs opacity-90">
        ...
      </p>
    </div>
  </div>

  <script>
    const API_BASE          = "https://api.mckuadrat.com/kirimpesan/";
    const INBOX_URL         = API_BASE + "inbox";
    const BACKEND_CUSTOM_URL = API_BASE + "custom";

    let allMessages  = [];
    let allThreads   = [];  // [{phone, name, lastText, lastTime, messages: []}]
    let activePhone  = null;

    function logout() {
      localStorage.removeItem("sb_logged_in");
      localStorage.removeItem("sb_school");
      window.location.href = "/kirimpesan/";
    }

    (function setSchoolLabel() {
      const storedSchool = localStorage.getItem("sb_school") || "sekolahpesatbogor";
      const SCHOOL_MAP = { "sekolahpesatbogor": "Sekolah Pesat Bogor" };
      const label = SCHOOL_MAP[storedSchool] || storedSchool;
      const el = document.getElementById("schoolLabel");
      if (el) el.textContent = label;
    })();

    function showToast(msg, dur = 2500) {
      const t = document.getElementById("toast");
      const p = document.getElementById("toastText");
      if (!t || !p) return;
      p.textContent = msg;
      t.classList.remove("hidden");
      clearTimeout(showToast._t);
      showToast._t = setTimeout(() => t.classList.add("hidden"), dur);
    }

    function formatDateTime(str) {
      if (!str) return "-";
      const d = new Date(str);
      if (isNaN(d.getTime())) return str;
      return d.toLocaleString("id-ID");
    }

    function formatTimeShort(str) {
      if (!str) return "";
      const d = new Date(str);
      if (isNaN(d.getTime())) return "";
      return d.toLocaleTimeString("id-ID", { hour: "2-digit", minute: "2-digit" });
    }

    function safe(v, def = "-") {
      if (v === null || typeof v === "undefined" || v === "") return def;
      return v;
    }

    function buildThreadsFromMessages(messages) {
      const map = {};

      messages.forEach((m) => {
        const phone = m.phone || m.from;
        if (!phone) return;
        if (!map[phone]) map[phone] = [];
        map[phone].push(m);
      });

      const threads = Object.keys(map).map((phone) => {
        const msgs = map[phone].slice().sort((a, b) => {
          const da = new Date(a.at || a.timestamp || 0).getTime();
          const db = new Date(b.at || b.timestamp || 0).getTime();
          return da - db;
        });

        const last = msgs[msgs.length - 1];
        const vars = last.vars_json || {};
        const nama = vars.var1 || "";

        return {
          phone,
          name: nama,
          lastText: last.message_text || "",
          lastTime: last.at || last.timestamp || null,
          messages: msgs
        };
      });

      threads.sort((a, b) => {
        const da = new Date(a.lastTime || 0).getTime();
        const db = new Date(b.lastTime || 0).getTime();
        return db - da;
      });

      return threads;
    }

    function renderThreadList() {
      const container = document.getElementById("threadList");
      const summaryEl = document.getElementById("threadSummary");
      const inboxCountEl = document.getElementById("inboxCount");
      if (!container) return;

      container.innerHTML = "";

      if (!allThreads.length) {
        container.innerHTML = `
          <div class="px-3 py-4 text-[11px] text-slate-500">
            Belum ada pesan masuk dari webhook.
          </div>
        `;
        summaryEl.textContent   = "0 percakapan";
        inboxCountEl.textContent = "0 percakapan";
        return;
      }

      inboxCountEl.textContent = allThreads.length + " percakapan";
      summaryEl.textContent    = allMessages.length + " pesan";

      allThreads.forEach((t) => {
        const isActive = (t.phone === activePhone);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "w-full flex items-start gap-2 px-3 py-2 text-left border-b border-slate-100 hover:bg-slate-50 " +
          (isActive ? "bg-slate-50" : "");

        const initial = (t.name || t.phone || "?").trim()[0] || "?";

        btn.innerHTML = `
          <div class="mt-0.5 flex h-7 w-7 items-center justify-center rounded-full bg-mcgreen/10 text-[11px] font-semibold text-mcgreen">
            ${initial.toUpperCase()}
          </div>
          <div class="flex-1 min-w-0">
            <div class="flex justify-between items-center gap-2">
              <div class="truncate">
                <div class="text-[11px] font-semibold text-slate-800">
                  ${t.name ? t.name : t.phone}
                </div>
                <div class="text-[10px] text-slate-500 font-mono truncate">
                  ${t.name ? t.phone : ""}
                </div>
              </div>
              <div class="text-[10px] text-slate-500 whitespace-nowrap">
                ${formatTimeShort(t.lastTime)}
              </div>
            </div>
            <div class="mt-0.5 text-[10px] text-slate-600 truncate">
              ${safe(t.lastText, "(tanpa teks)")}
            </div>
          </div>
        `;

        btn.addEventListener("click", () => {
          activePhone = t.phone;
          renderThreadList();
          renderChatWindow();
        });

        container.appendChild(btn);
      });
    }

    function renderChatWindow() {
      const chatTitle    = document.getElementById("chatTitle");
      const chatSubtitle = document.getElementById("chatSubtitle");
      const chatMeta     = document.getElementById("chatMeta");
      const chatWindow   = document.getElementById("chatWindow");
      const replyInput   = document.getElementById("replyText");
      const sendBtn      = document.getElementById("btnSendReply");

      if (!chatWindow) return;

      chatWindow.innerHTML = "";

      if (!activePhone) {
        chatTitle.textContent    = "Pilih percakapan di sebelah kiri";
        chatSubtitle.textContent = "Nomor & nama akan tampil di sini.";
        chatMeta.textContent     = "-";
        if (replyInput) replyInput.value = "";
        if (sendBtn) sendBtn.disabled = true;
        return;
      }

      const thread = allThreads.find((t) => t.phone === activePhone);
      if (!thread) {
        chatTitle.textContent    = "Pilih percakapan di sebelah kiri";
        chatSubtitle.textContent = "Nomor & nama akan tampil di sini.";
        chatMeta.textContent     = "-";
        if (replyInput) replyInput.value = "";
        if (sendBtn) sendBtn.disabled = true;
        return;
      }

      const displayName = thread.name || thread.phone;
      chatTitle.textContent    = displayName;
      chatSubtitle.textContent = thread.name ? thread.phone : "(nama tidak tersedia)";
      chatMeta.textContent     =
        thread.messages.length + " pesan ¬∑ terakhir " + formatDateTime(thread.lastTime);

      if (sendBtn) sendBtn.disabled = false;

      // Bubble chat (kiri = user, kanan = kita/outgoing)
      thread.messages.forEach((m) => {
        // DETEKSI OUTGOING
        const isOutgoing =
          m.message_type === "outgoing" ||   // yg kamu push di sendReply()
          m.direction === "outgoing" ||      // kalau backend kirim field direction
          m.from_me === true;                // kalau ada flag dari webhook

        const bubbleRow = document.createElement("div");
        bubbleRow.className =
          "flex mb-2 " + (isOutgoing ? "justify-end" : "justify-start");

        const bubble = document.createElement("div");
        bubble.className =
          "inline-flex flex-col max-w-[80%] px-3 py-2 shadow-sm border " +
          (isOutgoing
            // BUBBLE KITA (KANAN)
            ? "rounded-2xl rounded-tr-none bg-mcgreen text-white border-mcgreen"
            // BUBBLE USER (KIRI)
            : "rounded-2xl rounded-tl-none bg-white text-slate-800 border-slate-200");

        const metaLine = document.createElement("div");
        metaLine.className = "flex items-center justify-between gap-2 mb-0.5";

        const timeSpan = document.createElement("span");
        timeSpan.className =
          "text-[9px] " + (isOutgoing ? "text-white/70" : "text-slate-500");
        timeSpan.textContent = formatDateTime(m.at || m.timestamp || "");

        const typeSpan = document.createElement("span");
        typeSpan.className =
          "text-[9px] " +
          (m.is_quick_reply
            ? (isOutgoing ? "text-white" : "text-emerald-600")
            : (isOutgoing ? "text-white/70" : "text-slate-400"));
        typeSpan.textContent = m.is_quick_reply
          ? "Quick reply"
          : (m.message_type || "text");

        const textDiv = document.createElement("div");
        textDiv.className =
          "text-[11px] whitespace-pre-wrap break-words " +
          (isOutgoing ? "text-white" : "text-slate-800");
        textDiv.textContent = safe(m.message_text, "(tanpa teks)");

        metaLine.appendChild(timeSpan);
        metaLine.appendChild(typeSpan);
        bubble.appendChild(metaLine);
        bubble.appendChild(textDiv);

        bubbleRow.appendChild(bubble);
        chatWindow.appendChild(bubbleRow);
      });

      // scroll ke bawah
      chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    async function loadInbox() {
      try {
        showToast("Memuat kotak masuk...");
        const res = await fetch(INBOX_URL + "?limit=500");
        const data = await res.json();
        if (!res.ok || data.status !== "ok") {
          console.error("inbox error:", data);
          showToast("Gagal memuat kotak masuk");
          return;
        }

        allMessages = Array.isArray(data.messages) ? data.messages : [];

        allThreads = buildThreadsFromMessages(allMessages);

        if (!activePhone && allThreads.length > 0) {
          activePhone = allThreads[0].phone;
        } else if (activePhone && !allThreads.some(t => t.phone === activePhone)) {
          activePhone = allThreads.length ? allThreads[0].phone : null;
        }

        renderThreadList();
        renderChatWindow();
        showToast("Kotak masuk berhasil dimuat", 1800);
      } catch (err) {
        console.error(err);
        showToast("Error memuat kotak masuk");
      }
    }

    async function sendReply() {
      const replyInput = document.getElementById("replyText");
      const sendBtn    = document.getElementById("btnSendReply");
      if (!activePhone) {
        showToast("Pilih percakapan dulu");
        return;
      }
      const text = (replyInput?.value || "").trim();
      if (!text) {
        showToast("Isi pesan dulu");
        return;
      }

      sendBtn.disabled = true;
      showToast("Mengirim balasan...");

      try {
        const res = await fetch(BACKEND_CUSTOM_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            to: activePhone,
            text: text
          })
        });

        const data = await res.json();
        if (!res.ok || data.status !== "ok") {
          console.error("sendReply error:", data);
          showToast("Gagal mengirim balasan");
        } else {
          showToast("Balasan terkirim ‚úì");
          if (replyInput) replyInput.value = "";
          // opsional: tambahkan pseudo-bubble "outgoing" di UI
          const thread = allThreads.find((t) => t.phone === activePhone);
          if (thread) {
            const now = new Date().toISOString();
            thread.messages.push({
              at: now,
              message_text: text,
              message_type: "outgoing",
              is_quick_reply: false
            });
            thread.lastTime = now;
            renderChatWindow();
          }
        }
      } catch (err) {
        console.error(err);
        showToast("Error mengirim pesan");
      } finally {
        sendBtn.disabled = false;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadInbox();

      document.getElementById("btnRefresh").addEventListener("click", loadInbox);
      document.getElementById("btnSendReply").addEventListener("click", sendReply);

      document.getElementById("replyText").addEventListener("keypress", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendReply();
        }
      });
    });
  </script>
</body>
</html>
