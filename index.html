<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>MCKuadrat WA Broadcast</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            mcprimary: {
              DEFAULT: '#16a34a',
              dark: '#15803d',
            }
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-screen bg-slate-950 text-slate-50 flex items-center justify-center p-4">
  <div class="w-full max-w-5xl bg-slate-900/80 border border-slate-700 rounded-2xl shadow-2xl px-6 py-5 md:px-8 md:py-7">
    <!-- Header -->
    <header class="flex flex-col gap-2 mb-6 md:mb-8 md:flex-row md:items-center md:justify-between">
      <div>
        <div class="inline-flex items-center gap-2 text-xs uppercase tracking-[0.2em] text-slate-400 mb-1">
          <span class="h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
          MCKuadrat ¬∑ WhatsApp Cloud API
        </div>
        <h1 class="text-xl md:text-2xl font-semibold flex items-center gap-2">
          <span class="inline-flex items-center justify-center h-7 w-7 rounded-lg bg-emerald-500/10 text-emerald-400 text-sm">
            üì°
          </span>
          WA Broadcast Sender
        </h1>
        <p class="text-sm text-slate-400 mt-1">
          Kirim pesan template ke banyak nomor sekaligus. Template diambil otomatis dari WhatsApp Manager.
        </p>
      </div>
      <div class="text-xs text-right text-slate-400">
        <div><span class="font-semibold text-slate-200">Frontend:</span> app.mckuadrat.com</div>
        <div><span class="font-semibold text-slate-200">Backend:</span> api.mckuadrat.com</div>
        <div class="text-emerald-400 font-semibold mt-1">‚óè API Connected</div>
      </div>
    </header>

    <main class="grid gap-6 md:grid-cols-[minmax(0,1.1fr)_minmax(0,0.9fr)]">
      <!-- LEFT: Main Form -->
      <section class="space-y-6">
        <!-- Template & Message -->
        <div class="space-y-4 rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-5">
          <div>
            <h2 class="flex items-center gap-2 text-base font-semibold">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-mcprimary/10 text-mcprimary text-xs">
                1
              </span>
              Pilih Template & Pesan
            </h2>
            <p class="text-xs text-slate-400 mt-1">
              Pilih template WhatsApp yang sudah <span class="font-semibold text-slate-200">APPROVED</span> di Meta.
            </p>
          </div>

          <!-- Template Selection -->
          <div class="space-y-2">
            <label class="text-sm font-medium text-slate-200 flex items-center justify-between">
              <span>Pilih Template</span>
              <span id="templateStatus" class="text-[11px] uppercase tracking-[0.18em] text-slate-400">Loading...</span>
            </label>
            <select
              id="templateSelect"
              class="w-full rounded-xl border border-slate-700 bg-slate-950/80 px-3 py-2 text-sm text-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            >
              <option value="">(Memuat template...)</option>
            </select>
          </div>

          <!-- Message Preview -->
          <div class="space-y-2">
            <div class="flex items-center justify-between">
              <label for="messagePreview" class="text-sm font-medium text-slate-200">
                Preview Body Template
              </label>
              <span class="text-[11px] text-slate-400">
                Variabel: <code class="px-1 rounded bg-slate-800 text-[11px]">{{1}}</code>
                <code class="px-1 rounded bg-slate-800 text-[11px]">{{2}}</code>
                <code class="px-1 rounded bg-slate-800 text-[11px]">{{3}}</code>
              </span>
            </div>
            <textarea
              id="messagePreview"
              class="w-full rounded-xl border border-slate-700 bg-slate-950/80 px-3 py-2.5 text-sm text-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 min-h-[120px]"
              placeholder="Body template dari Meta akan muncul di sini setelah memilih template..."
              readonly
            ></textarea>
          </div>
        </div>

        <!-- Recipients -->
        <div class="space-y-4 rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-5">
          <div class="flex items-center justify-between">
            <h2 class="flex items-center gap-2 text-base font-semibold">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-mcprimary/10 text-mcprimary text-xs">
                2
              </span>
              Penerima Broadcast
            </h2>
            <span class="inline-flex items-center gap-1 rounded-full border border-slate-600 bg-slate-950/80 px-2.5 py-1 text-[11px] text-slate-300">
              <span class="inline-flex h-1.5 w-1.5 rounded-full bg-emerald-400"></span>
              <span id="recipientCount">0</span> nomor
            </span>
          </div>

          <!-- Add Recipient manually -->
          <div class="flex flex-col gap-2 sm:flex-row">
            <input
              id="manualPhone"
              type="text"
              class="flex-1 rounded-xl border border-slate-700 bg-slate-950/80 px-3 py-2 text-sm text-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
              placeholder="Tambah nomor manual (contoh: 6281234567890)"
            />
            <button
              type="button"
              id="btnAddRecipient"
              class="inline-flex items-center justify-center rounded-xl border border-emerald-500/70 bg-emerald-500/10 px-4 py-2 text-sm font-medium text-emerald-300 hover:bg-emerald-500/20"
            >
              Tambah
            </button>
          </div>

          <!-- CSV Upload -->
          <div class="flex flex-col gap-2 sm:flex-row sm:items-center">
            <label class="text-xs text-slate-400">
              Atau upload CSV
              <span class="block text-[11px] text-slate-500">
                Format: <code>no_wa,var1</code> per baris (tanpa header)
              </span>
            </label>
            <div class="flex gap-2 sm:ml-auto">
              <input id="csvFile" type="file" accept=".csv" class="hidden" />
              <button
                type="button"
                id="btnUploadCsv"
                class="inline-flex items-center justify-center rounded-xl border border-slate-600 bg-slate-950/80 px-3 py-2 text-xs font-medium text-slate-200 hover:bg-slate-800"
              >
                üìÅ Upload CSV
              </button>
              <span id="csvInfo" class="text-[11px] text-slate-400 self-center"></span>
            </div>
          </div>

          <!-- Recipients List -->
          <div
            id="recipientList"
            class="mt-2 max-h-52 overflow-y-auto rounded-xl border border-slate-800 bg-slate-950/70 text-xs text-slate-200 p-2 space-y-1 hidden"
          ></div>
        </div>

        <!-- Scheduling -->
        <div class="space-y-3 rounded-2xl border border-slate-700 bg-slate-900/70 p-4 md:p-5">
          <div class="flex items-center justify-between">
            <h2 class="flex items-center gap-2 text-base font-semibold">
              <span class="inline-flex h-6 w-6 items-center justify-center rounded-full bg-mcprimary/10 text-mcprimary text-xs">
                3
              </span>
              Jadwal (Opsional)
            </h2>
          </div>
          <div class="space-y-2">
            <label for="schedule" class="text-sm font-medium text-slate-200">Waktu Kirim</label>
            <input
              id="schedule"
              type="datetime-local"
              class="w-full rounded-xl border border-slate-700 bg-slate-950/80 px-3 py-2 text-sm text-slate-50 outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
            />
            <p class="text-[11px] text-slate-400">
              Kosongkan jika ingin langsung kirim sekarang. (Untuk sementara jadwal hanya sebatas catatan, belum di-queue di server.)
            </p>
          </div>
        </div>

        <!-- Send Button + Output -->
        <div class="space-y-3">
          <button
            id="sendBtn"
            class="w-full inline-flex items-center justify-center rounded-xl bg-mcprimary px-4 py-2.5 text-sm font-semibold text-white shadow-lg shadow-emerald-500/40 hover:bg-mcprimary-dark"
          >
            üì° <span class="ml-2" id="sendBtnLabel">Kirim Broadcast Sekarang</span>
          </button>

          <div class="space-y-1">
            <div class="text-[11px] text-slate-400 flex items-center gap-1">
              <span class="h-1.5 w-1.5 rounded-full bg-sky-400"></span>
              Log respon API
            </div>
            <pre
              id="output"
              class="max-h-60 overflow-auto rounded-xl border border-slate-800 bg-slate-950/80 p-2 text-[11px] text-slate-200"
            >// Hasil kirim broadcast akan muncul di sini</pre>
          </div>
        </div>
      </section>

      <!-- RIGHT: Summary -->
      <aside class="space-y-4">
        <div class="rounded-2xl border border-sky-700/70 bg-sky-900/20 p-4 md:p-5">
          <h3 class="text-sm font-semibold text-slate-100 mb-2 flex items-center gap-2">
            <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-sky-500/20 text-sky-400 text-[11px]">
              ‚Ñπ
            </span>
            Ringkasan Broadcast
          </h3>
          <dl class="space-y-1.5 text-sm">
            <div class="flex justify-between gap-2">
              <dt class="text-slate-400">Jumlah penerima</dt>
              <dd class="text-slate-50" id="summaryRecipients">0</dd>
            </div>
            <div class="flex justify-between gap-2">
              <dt class="text-slate-400">Template</dt>
              <dd class="text-slate-50 text-right" id="summaryTemplate">Belum dipilih</dd>
            </div>
            <div class="flex justify-between gap-2">
              <dt class="text-slate-400">Waktu kirim</dt>
              <dd class="text-slate-50 text-right" id="summarySchedule">Segera</dd>
            </div>
          </dl>
          <p class="mt-3 text-xs text-slate-400">
            Pastikan template sudah <span class="font-semibold text-slate-200">APPROVED</span> di WhatsApp Manager dan nomor penerima sudah benar.
          </p>
        </div>

        <div class="rounded-2xl border border-slate-700 bg-slate-900/70 p-4 text-xs text-slate-400 space-y-2">
          <p class="font-semibold text-slate-200">Catatan format CSV</p>
          <ul class="list-disc list-inside space-y-1">
            <li>Tanpa header.</li>
            <li>Kolom 1: nomor WhatsApp (misal <code>6281234567890</code>).</li>
            <li>Kolom 2: variabel pertama <code>{{1}}</code> (misal nama orang tua).</li>
          </ul>
        </div>
      </aside>
    </main>
  </div>

  <script>
    const API_BASE = "https://api.mckuadrat.com";
    const BACKEND_BROADCAST_URL = API_BASE + "/broadcast";
    const BACKEND_TEMPLATES_URL = API_BASE + "/templates";

    let templates = [];
    let recipients = []; // { phone, var1 }

    // Helper update summary & count
    function updateRecipientUI() {
      const count = recipients.length;
      document.getElementById("recipientCount").textContent = count;
      document.getElementById("summaryRecipients").textContent = count;

      const listEl = document.getElementById("recipientList");
      listEl.innerHTML = "";

      if (count === 0) {
        listEl.classList.add("hidden");
        return;
      }

      listEl.classList.remove("hidden");

      recipients.forEach((r, idx) => {
        const row = document.createElement("div");
        row.className = "flex items-center justify-between rounded-lg bg-slate-900/90 px-2 py-1.5";
        row.innerHTML = `
          <div class="text-[11px]">
            <div class="font-mono text-slate-100">${r.phone}</div>
            ${r.var1 ? `<div class="text-slate-400">Var1: ${r.var1}</div>` : ""}
          </div>
          <button data-idx="${idx}" class="text-[11px] text-red-400 hover:text-red-300">‚úï</button>
        `;
        listEl.appendChild(row);
      });

      // attach remove handlers
      Array.from(listEl.querySelectorAll("button[data-idx]")).forEach(btn => {
        btn.addEventListener("click", () => {
          const i = parseInt(btn.getAttribute("data-idx"), 10);
          if (!isNaN(i)) {
            recipients.splice(i, 1);
            updateRecipientUI();
          }
        });
      });
    }

    function updateSummarySchedule() {
      const val = document.getElementById("schedule").value;
      const summaryEl = document.getElementById("summarySchedule");
      const labelEl = document.getElementById("sendBtnLabel");

      if (!val) {
        summaryEl.textContent = "Segera";
        labelEl.textContent = "Kirim Broadcast Sekarang";
        return;
      }
      const dt = new Date(val);
      if (isNaN(dt.getTime())) {
        summaryEl.textContent = "Segera";
        labelEl.textContent = "Kirim Broadcast Sekarang";
        return;
      }
      summaryEl.textContent = dt.toLocaleString();
      labelEl.textContent = "Jadwalkan Broadcast";
    }

    // Load templates from backend
    async function loadTemplates() {
      const sel = document.getElementById("templateSelect");
      const statusEl = document.getElementById("templateStatus");
      statusEl.textContent = "Loading...";

      try {
        const res = await fetch(BACKEND_TEMPLATES_URL + "?status=APPROVED");
        const data = await res.json();

        if (data.status !== "ok") {
          sel.innerHTML = '<option value="">Gagal memuat template</option>';
          statusEl.textContent = "Error";
          console.error("Error templates:", data);
          return;
        }

        templates = Array.isArray(data.templates) ? data.templates : [];
        if (!templates.length) {
          sel.innerHTML = '<option value="">Tidak ada template APPROVED</option>';
          statusEl.textContent = "Kosong";
          return;
        }

        sel.innerHTML = "";
        templates.forEach(tpl => {
          const opt = document.createElement("option");
          opt.value = tpl.name;
          opt.textContent = `${tpl.name} [${tpl.category}/${tpl.language}]`;
          sel.appendChild(opt);
        });

        statusEl.textContent = templates.length + " template";
      } catch (err) {
        console.error(err);
        sel.innerHTML = '<option value="">Error memuat template</option>';
        statusEl.textContent = "Error";
      }
    }

    function getTemplateBodyText(tpl) {
      if (!tpl || !Array.isArray(tpl.components)) return "";
      const bodyComp = tpl.components.find(c => c.type === "BODY");
      return bodyComp?.text || "";
    }

    document.addEventListener("DOMContentLoaded", () => {
      loadTemplates();

      // Template change -> update preview & summary
      const selTpl = document.getElementById("templateSelect");
      const previewEl = document.getElementById("messagePreview");
      selTpl.addEventListener("change", () => {
        const name = selTpl.value;
        const tpl = templates.find(t => t.name === name);
        previewEl.value = getTemplateBodyText(tpl) || "";
        document.getElementById("summaryTemplate").textContent = name || "Belum dipilih";
      });

      // Manual add recipient
      document.getElementById("btnAddRecipient").addEventListener("click", () => {
        const input = document.getElementById("manualPhone");
        const phone = input.value.trim();
        if (!phone) return;
        if (recipients.some(r => r.phone === phone)) {
          input.value = "";
          return;
        }
        recipients.push({ phone, var1: "" });
        input.value = "";
        updateRecipientUI();
      });

      // Enter key on manual input
      document.getElementById("manualPhone").addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          document.getElementById("btnAddRecipient").click();
        }
      });

      // CSV upload trigger
      document.getElementById("btnUploadCsv").addEventListener("click", () => {
        document.getElementById("csvFile").click();
      });

      document.getElementById("csvFile").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        const infoEl = document.getElementById("csvInfo");
        if (!file) {
          infoEl.textContent = "";
          return;
        }
        try {
          const text = await file.text();
          const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
          let added = 0;
          for (const line of lines) {
            const parts = line.split(",");
            const phone = (parts[0] || "").trim();
            const var1  = (parts[1] || "").trim();
            if (!phone) continue;
            if (recipients.some(r => r.phone === phone)) continue;
            recipients.push({ phone, var1 });
            added++;
          }
          infoEl.textContent = `CSV: ${added} nomor baru ditambahkan`;
          updateRecipientUI();
        } catch (err) {
          console.error(err);
          infoEl.textContent = "Gagal membaca CSV";
        }
      });

      // Schedule change
      document.getElementById("schedule").addEventListener("change", updateSummarySchedule);

      // Send broadcast
      document.getElementById("sendBtn").addEventListener("click", async () => {
        const outputEl = document.getElementById("output");
        const sel = document.getElementById("templateSelect");
        const templateName = sel.value;

        if (!templateName) {
          alert("Pilih template terlebih dahulu.");
          return;
        }
        if (!recipients.length) {
          alert("Tambahkan minimal satu penerima (manual atau dari CSV).");
          return;
        }

        outputEl.textContent = `Mengirim ke ${recipients.length} nomor...`;

        try {
          const res = await fetch(BACKEND_BROADCAST_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              template_name: templateName,
              rows: recipients
            })
          });

          const data = await res.json();
          outputEl.textContent = JSON.stringify(data, null, 2);
        } catch (err) {
          console.error(err);
          outputEl.textContent = "Error: " + err.message;
        }
      });
    });
  </script>
</body>
</html>
